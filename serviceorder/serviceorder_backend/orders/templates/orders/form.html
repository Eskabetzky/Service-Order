{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="contact" id="contact">
    <div class="home-image">
        <img src="{% static 'images/Department_of_Agrarian_Reform_(DAR).svg.png' %}" alt="">
    </div>
    <div class="heading-h2">
        <h2 class="heading">Department of Agrarian Reform</h2> 
    </div>
    <div class="heading-h2">
        <h2 class="heading">Service Order</h2> 
    </div>

    <form id="serviceOrderForm" method="post" action="{% url 'service_order_form' %}">
        {% csrf_token %}
        <input type="hidden" name="service_records" id="serviceRecordsData">
                
        <div>
            <label class="input-label1">Full Name <br> <input type="text" name="full_name" placeholder=" " required></label>
        </div> 
        <div id="grid-container">
            <label class="input-label2">Birth <br><br>
                <input type="date" name="birth_date" placeholder="Birthdate" required>
                <input type="text" name="birth_place" placeholder="Birth place" required>
            </label>
        </div>
        
        <table class="customTable" id="travelTable">
            <thead>
                <tr>
                    <th>Add</th>
                    <th colspan="2" width="60px">Service</th>
                    <th colspan="2" width="350px">Record of Appointment</th>
                    <th colspan="3" width="359px">Office Entity/Division</th>
                    <th colspan="1" width="80px">LWOP</th>
                    <th colspan="2" width="287px">Separation</th>
                    <th width="20px">Delete</th>
                </tr>
                <tr>
                    <th width="20px" style="font-size:24px">+</th>
                    <th width="30px">From</th>
                    <th width="30px">To</th>
                    <th width="250px">Designation</th>
                    <th width="100px">Status</th>
                    <th width="130px">Salary</th>
                    <th width="115px">Station of Assignment</th>
                    <th width="114px">Branch</th>
                    <th width="80px"> </th>
                    <th width="87.5px">Date</th>
                    <th width="150px">Cause</th>
                    <th width="20px">Delete</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added dynamically here -->
            </tbody>
        </table>
        <input type="button" value="Save" class="btn no-print" id="saveBtn">
        <button class="btn no-print" onclick="window.print()" value="Print">Print</button>
    </form>
</section>

<script>
    // Function to add a new row
    function addRow() {
        const table = document.getElementById("travelTable").getElementsByTagName("tbody")[0];
        const newRow = table.insertRow();

        // Add "Add" icon
        const addCell = newRow.insertCell(0);
        addCell.innerHTML = '<span class="add-icon" onclick="addRow()">+</span>';

        // Add input fields
        const fields = [
            {type: "date", name: "service_from"},
            {type: "date", name: "service_to"},
            {type: "text", name: "designation"},
            {type: "text", name: "status"},
            {type: "number", name: "salary", step: "0.01"},
            {type: "text", name: "station_of_assignment"},
            {type: "text", name: "branch"},
            {type: "text", name: "lwop"},
            {type: "date", name: "separation_date"},
            {type: "text", name: "separation_cause"}
        ];
        
        for (let i = 0; i < fields.length; i++) {
            const cell = newRow.insertCell(i + 1);
            cell.innerHTML = `<input type="${fields[i].type}" name="records[][${fields[i].name}]" ${fields[i].step ? `step="${fields[i].step}"` : ''} placeholder="enter ${fields[i].name}">`;
        }

        // Add "Delete" icon
        const deleteCell = newRow.insertCell(fields.length + 1);
        deleteCell.innerHTML = '<span class="delete-icon" onclick="deleteRow(this)">üóëÔ∏è</span>';
    }

    // Function to delete a row
    function deleteRow(button) {
        const row = button.parentElement.parentElement;
        row.remove();
    }

    // Add the first row on page load
    document.addEventListener("DOMContentLoaded", addRow);

    // Save button functionality
    document.getElementById('saveBtn').addEventListener('click', function() {
        const form = document.getElementById('serviceOrderForm');
        const formData = new FormData(form);
        
        // Collect service records data
        const records = [];
        const rows = document.querySelectorAll('#travelTable tbody tr');
        
        rows.forEach(row => {
            const record = {};
            const inputs = row.querySelectorAll('input');
            
            inputs.forEach(input => {
                const nameParts = input.name.match(/records\[\]\[(.*?)\]/);
                if (nameParts && nameParts.length > 1) {
                    const fieldName = nameParts[1];
                    record[fieldName] = input.value;
                }
            });
            
            if (Object.keys(record).length > 0) {
                records.push(record);
            }
        });
        
        // Add records to form data
        document.getElementById('serviceRecordsData').value = JSON.stringify(records);
        
        // Submit form via AJAX
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Service order saved successfully!');
                // Optionally redirect or clear form
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving.');
        });
    });
</script>
{% endblock %}